{
  "hash": "6833a78c59a0693b7925e99614900277",
  "result": {
    "engine": "knitr",
    "markdown": "# Workflow without using `BayesERtools`\n\nThis page shows how to perform ER analysis without using `BayesERtools` package\nto help:\n\n- Understand the internal workings of the package\n- Flexibility to customize the analysis\n\n## Setup and load\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(here)\nlibrary(gt)\n\ntheme_set(theme_bw(base_size = 12))\n```\n:::\n\n\n\n\n\n\n\n## Data\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata(d_sim_binom_cov, package = \"BayesERtools\")\n\nd_sim_binom_cov_2 <-\n  d_sim_binom_cov |>\n  mutate(\n    AUCss_1000 = AUCss / 1000, BAGE_10 = BAGE / 10,\n    BWT_10 = BWT / 10, BHBA1C_5 = BHBA1C / 5\n  )\n\n# Grade 2+ hypoglycemia\ndf_er_ae_hgly2 <- d_sim_binom_cov_2 |> filter(AETYPE == \"hgly2\")\n\nvar_exposure <- \"AUCss_1000\"\nvar_resp <- \"AEFLAG\"\nvar_cov_ae_hgly2 <- c(\"BAGE_10\", \"BWT_10\", \"RACE\", \"VISC\", \"BHBA1C_5\", \"BGLUC\")\n```\n:::\n\n\n\n\n\n## Basic model development\n\n`dev_ermod_bin()` function can be used to develop basic ER model. (Note that\nthis function can also be used for models with covariates, if you already know\nthe covariates to be included.)\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nset.seed(1234)\n\nvar_all <- c(var_exposure) # If you have covariates, you can add here\n\nformula_all <-\n  stats::formula(glue::glue(\n    \"{var_resp} ~ {paste(var_all, collapse = ' + ')}\"\n  ))\n\nermod_bin <- rstanarm::stan_glm(\n  formula_all,\n  family = stats::binomial(),\n  data = df_er_ae_hgly2,\n  QR = dplyr::if_else(length(var_all) > 1, TRUE, FALSE),\n  refresh = 0, # Suppress output\n)\n\nermod_bin\n```\n\n<pre class=\"r-output\"><code>stan_glm\n family:       binomial [logit]\n formula:      AEFLAG ~ AUCss_1000\n observations: 500\n predictors:   2\n------\n            Median MAD_SD\n(Intercept) -2.0    0.2  \nAUCss_1000   0.4    0.1  \n\n------\n* For help interpreting the printed output see ?print.stanreg\n* For info on the priors used see ?prior_summary.stanreg\n</code></pre>\n:::\n\n\n\n\nPerform simulation for plotting purpose\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nexposure_range <-\n  range(df_er_ae_hgly2[[var_exposure]])\n\nexposure_to_sim_vec <-\n  seq(exposure_range[1], exposure_range[2], length.out = 51)\n\ndata_for_sim <-\n  tibble(!!var_exposure := exposure_to_sim_vec)\n\nsim_epred_med_qi <-\n  tidybayes::add_epred_draws(data_for_sim, ermod_bin) |>\n  tidybayes::median_qi() |>\n  dplyr::as_tibble()\n```\n:::\n\n\n\n\nObserved vs model predicted plot:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(data = sim_epred_med_qi, aes(x = .data[[var_exposure]], y = .epred)) +\n  geom_ribbon(aes(ymin = .lower, ymax = .upper), alpha = 0.3) +\n  geom_line() +\n  # Observed data plots\n  geom_jitter(\n    data = df_er_ae_hgly2,\n    aes(x = .data[[var_exposure]], y = .data[[var_resp]]),\n    width = 0, height = 0.05, alpha = 0.5\n  ) +\n  xgxr::xgx_stat_ci(\n    data = df_er_ae_hgly2,\n    aes(x = .data[[var_exposure]], y = .data[[var_resp]]),\n    bins = 4, conf_level = 0.95, distribution = \"binomial\",\n    geom = c(\"point\"), shape = 0, size = 4\n  ) +\n  xgxr::xgx_stat_ci(\n    data = df_er_ae_hgly2,\n    aes(x = .data[[var_exposure]], y = .data[[var_resp]]),\n    bins = 4, conf_level = 0.95, distribution = \"binomial\",\n    geom = c(\"errorbar\"), linewidth = 0.5\n  ) +\n  # Figure settings\n  coord_cartesian(ylim = c(-0.05, 1.05)) +\n  scale_y_continuous(\n    breaks = c(0, .5, 1),\n    labels = scales::percent\n  ) +\n  labs(x = var_exposure, y = \"Probability of event\")\n```\n\n::: {.cell-output-display}\n![](workflow_wo_package_files/figure-html/fig-plot-er-1.png){#fig-plot-er width=672}\n:::\n:::\n\n\n\n\nMCMC samples can be obtained with `as_draws()` family of functions, such as\n`as_draws_df()`.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndraws_df <- posterior::as_draws_df(ermod_bin)\n\ndraws_df_summary <-\n  posterior::summarize_draws(draws_df)\n\ndraws_df_summary |>\n  gt::gt() |>\n  gt::fmt_number(n_sigfig = 3)\n```\n\n::: {.cell-output-display}\n`````{=html}\n<pre class=\"r-output\"><code>\n```{=html}\n<div id=\"nnknajtwbo\" style=\"padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;\">\n<style>#nnknajtwbo table {\n  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';\n  -webkit-font-smoothing: antialiased;\n  -moz-osx-font-smoothing: grayscale;\n}\n\n#nnknajtwbo thead, #nnknajtwbo tbody, #nnknajtwbo tfoot, #nnknajtwbo tr, #nnknajtwbo td, #nnknajtwbo th {\n  border-style: none;\n}\n\n#nnknajtwbo p {\n  margin: 0;\n  padding: 0;\n}\n\n#nnknajtwbo .gt_table {\n  display: table;\n  border-collapse: collapse;\n  line-height: normal;\n  margin-left: auto;\n  margin-right: auto;\n  color: #333333;\n  font-size: 16px;\n  font-weight: normal;\n  font-style: normal;\n  background-color: #FFFFFF;\n  width: auto;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #A8A8A8;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #A8A8A8;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n}\n\n#nnknajtwbo .gt_caption {\n  padding-top: 4px;\n  padding-bottom: 4px;\n}\n\n#nnknajtwbo .gt_title {\n  color: #333333;\n  font-size: 125%;\n  font-weight: initial;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-color: #FFFFFF;\n  border-bottom-width: 0;\n}\n\n#nnknajtwbo .gt_subtitle {\n  color: #333333;\n  font-size: 85%;\n  font-weight: initial;\n  padding-top: 3px;\n  padding-bottom: 5px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-color: #FFFFFF;\n  border-top-width: 0;\n}\n\n#nnknajtwbo .gt_heading {\n  background-color: #FFFFFF;\n  text-align: center;\n  border-bottom-color: #FFFFFF;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#nnknajtwbo .gt_bottom_border {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#nnknajtwbo .gt_col_headings {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#nnknajtwbo .gt_col_heading {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 6px;\n  padding-left: 5px;\n  padding-right: 5px;\n  overflow-x: hidden;\n}\n\n#nnknajtwbo .gt_column_spanner_outer {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  padding-top: 0;\n  padding-bottom: 0;\n  padding-left: 4px;\n  padding-right: 4px;\n}\n\n#nnknajtwbo .gt_column_spanner_outer:first-child {\n  padding-left: 0;\n}\n\n#nnknajtwbo .gt_column_spanner_outer:last-child {\n  padding-right: 0;\n}\n\n#nnknajtwbo .gt_column_spanner {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 5px;\n  overflow-x: hidden;\n  display: inline-block;\n  width: 100%;\n}\n\n#nnknajtwbo .gt_spanner_row {\n  border-bottom-style: hidden;\n}\n\n#nnknajtwbo .gt_group_heading {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  text-align: left;\n}\n\n#nnknajtwbo .gt_empty_group_heading {\n  padding: 0.5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: middle;\n}\n\n#nnknajtwbo .gt_from_md > :first-child {\n  margin-top: 0;\n}\n\n#nnknajtwbo .gt_from_md > :last-child {\n  margin-bottom: 0;\n}\n\n#nnknajtwbo .gt_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  margin: 10px;\n  border-top-style: solid;\n  border-top-width: 1px;\n  border-top-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  overflow-x: hidden;\n}\n\n#nnknajtwbo .gt_stub {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#nnknajtwbo .gt_stub_row_group {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n  vertical-align: top;\n}\n\n#nnknajtwbo .gt_row_group_first td {\n  border-top-width: 2px;\n}\n\n#nnknajtwbo .gt_row_group_first th {\n  border-top-width: 2px;\n}\n\n#nnknajtwbo .gt_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#nnknajtwbo .gt_first_summary_row {\n  border-top-style: solid;\n  border-top-color: #D3D3D3;\n}\n\n#nnknajtwbo .gt_first_summary_row.thick {\n  border-top-width: 2px;\n}\n\n#nnknajtwbo .gt_last_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#nnknajtwbo .gt_grand_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#nnknajtwbo .gt_first_grand_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-style: double;\n  border-top-width: 6px;\n  border-top-color: #D3D3D3;\n}\n\n#nnknajtwbo .gt_last_grand_summary_row_top {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-style: double;\n  border-bottom-width: 6px;\n  border-bottom-color: #D3D3D3;\n}\n\n#nnknajtwbo .gt_striped {\n  background-color: rgba(128, 128, 128, 0.05);\n}\n\n#nnknajtwbo .gt_table_body {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#nnknajtwbo .gt_footnotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#nnknajtwbo .gt_footnote {\n  margin: 0px;\n  font-size: 90%;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#nnknajtwbo .gt_sourcenotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#nnknajtwbo .gt_sourcenote {\n  font-size: 90%;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#nnknajtwbo .gt_left {\n  text-align: left;\n}\n\n#nnknajtwbo .gt_center {\n  text-align: center;\n}\n\n#nnknajtwbo .gt_right {\n  text-align: right;\n  font-variant-numeric: tabular-nums;\n}\n\n#nnknajtwbo .gt_font_normal {\n  font-weight: normal;\n}\n\n#nnknajtwbo .gt_font_bold {\n  font-weight: bold;\n}\n\n#nnknajtwbo .gt_font_italic {\n  font-style: italic;\n}\n\n#nnknajtwbo .gt_super {\n  font-size: 65%;\n}\n\n#nnknajtwbo .gt_footnote_marks {\n  font-size: 75%;\n  vertical-align: 0.4em;\n  position: initial;\n}\n\n#nnknajtwbo .gt_asterisk {\n  font-size: 100%;\n  vertical-align: 0;\n}\n\n#nnknajtwbo .gt_indent_1 {\n  text-indent: 5px;\n}\n\n#nnknajtwbo .gt_indent_2 {\n  text-indent: 10px;\n}\n\n#nnknajtwbo .gt_indent_3 {\n  text-indent: 15px;\n}\n\n#nnknajtwbo .gt_indent_4 {\n  text-indent: 20px;\n}\n\n#nnknajtwbo .gt_indent_5 {\n  text-indent: 25px;\n}\n\n#nnknajtwbo .katex-display {\n  display: inline-flex !important;\n  margin-bottom: 0.75em !important;\n}\n\n#nnknajtwbo div.Reactable > div.rt-table > div.rt-thead > div.rt-tr.rt-tr-group-header > div.rt-th-group:after {\n  height: 0px !important;\n}\n</style>\n<table class=\"gt_table\" data-quarto-disable-processing=\"false\" data-quarto-bootstrap=\"false\">\n  <thead>\n    <tr class=\"gt_col_headings\">\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_left\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"variable\">variable</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"mean\">mean</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"median\">median</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"sd\">sd</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"mad\">mad</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"q5\">q5</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"q95\">q95</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"rhat\">rhat</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"ess_bulk\">ess_bulk</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"ess_tail\">ess_tail</th>\n    </tr>\n  </thead>\n  <tbody class=\"gt_table_body\">\n    <tr><td headers=\"variable\" class=\"gt_row gt_left\">(Intercept)</td>\n<td headers=\"mean\" class=\"gt_row gt_right\">−2.05</td>\n<td headers=\"median\" class=\"gt_row gt_right\">−2.04</td>\n<td headers=\"sd\" class=\"gt_row gt_right\">0.234</td>\n<td headers=\"mad\" class=\"gt_row gt_right\">0.228</td>\n<td headers=\"q5\" class=\"gt_row gt_right\">−2.43</td>\n<td headers=\"q95\" class=\"gt_row gt_right\">−1.67</td>\n<td headers=\"rhat\" class=\"gt_row gt_right\">1.00</td>\n<td headers=\"ess_bulk\" class=\"gt_row gt_right\">2,230</td>\n<td headers=\"ess_tail\" class=\"gt_row gt_right\">1,870</td></tr>\n    <tr><td headers=\"variable\" class=\"gt_row gt_left\">AUCss_1000</td>\n<td headers=\"mean\" class=\"gt_row gt_right\">0.412</td>\n<td headers=\"median\" class=\"gt_row gt_right\">0.412</td>\n<td headers=\"sd\" class=\"gt_row gt_right\">0.0761</td>\n<td headers=\"mad\" class=\"gt_row gt_right\">0.0765</td>\n<td headers=\"q5\" class=\"gt_row gt_right\">0.288</td>\n<td headers=\"q95\" class=\"gt_row gt_right\">0.537</td>\n<td headers=\"rhat\" class=\"gt_row gt_right\">1.00</td>\n<td headers=\"ess_bulk\" class=\"gt_row gt_right\">2,150</td>\n<td headers=\"ess_tail\" class=\"gt_row gt_right\">2,140</td></tr>\n  </tbody>\n  \n  \n</table>\n</div>\n```\n</code></pre>\n`````\n:::\n:::\n\n\n\n\n\n## Selection of exposure metrics\n\nFirst you fit models with all the candidate exposure metrics and then compare\nthe models using leave-one-out cross-validation (LOO).\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nset.seed(1234)\n\n# Run models with all the candidate exposure metrics\nl_mod_exposures <-\n  c(\"AUCss_1000\", \"Cmaxss\", \"Cminss\") |>\n  purrr::set_names() |>\n  purrr::map(\n    function(.x) {\n      formula <- stats::formula(glue::glue(\"{var_resp} ~ {.x}\"))\n\n      mod <- rstanarm::stan_glm(\n        formula,\n        family = stats::binomial(),\n        data = df_er_ae_hgly2,\n        refresh = 0 # Suppress output\n      )\n    },\n    .progress = TRUE\n  )\n\n# Calculate loo (leave-one-out cross-validation) for each model\n# and compare the models\nl_loo_exposures <- purrr::map(l_mod_exposures, loo::loo)\nloo::loo_compare(l_loo_exposures)\n```\n\n<pre class=\"r-output\"><code>           elpd_diff se_diff\nAUCss_1000  0.0       0.0   \nCminss     -4.4       3.1   \nCmaxss     -5.1       2.9   \n</code></pre>\n:::\n\n\n\n\n\n## Selection of covariates\n\nSelection of covariates are be done with `projpred` package in `BayesERtools`.\n\n### Step 1: Full reference model fit\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nvarnames <- paste(c(var_exposure, var_cov_ae_hgly2), collapse = \" + \")\nformula_full <-\n  stats::formula(\n    glue::glue(\n      \"{var_resp} ~ {varnames}\"\n    )\n  )\n\n# Need to construct call and then evaluate. Directly calling\n# rstanarm::stan_glm with formula_full does not work for the cross-validation\ncall_fit_ref <-\n  rlang::call2(rstanarm::stan_glm,\n    formula = formula_full,\n    family = quote(stats::binomial()), data = quote(df_er_ae_hgly2), QR = TRUE,\n    refresh = 0)\nfit_ref <- eval(call_fit_ref)\n\nrefm_obj <- projpred::get_refmodel(fit_ref)\n```\n:::\n\n\n\n\n### Step 2: Variable selection\n\nThe code below shows example of variable selection with K-fold cross-validation\napproach.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Force exposure metric to be always included first\nsearch_terms <- projpred::force_search_terms(\n  forced_terms = var_exposure,\n  optional_terms = var_cov_ae_hgly2\n)\n\ncvvs <- projpred::cv_varsel(\n  refm_obj,\n  search_terms = search_terms,\n  cv_method = \"kfold\",\n  method = \"forward\",\n  validate_search = TRUE,\n  refit_prj = TRUE # Evaluation often look strange without refit\n)\n```\n\n<pre class=\"r-output\"><code>-----\nRunning the search using the full dataset ...\n10% of terms selected\n20% of terms selected\n40% of terms selected\n50% of terms selected\n70% of terms selected\n80% of terms selected\n100% of terms selected\n-----\n-----\nRefitting the reference model K = 5 times (using the fold-wise training data) ...\n</code></pre><pre class=\"r-output\"><code>Fitting model 1 out of 5\n</code></pre><pre class=\"r-output\"><code>Fitting model 2 out of 5\n</code></pre><pre class=\"r-output\"><code>Fitting model 3 out of 5\n</code></pre><pre class=\"r-output\"><code>Fitting model 4 out of 5\n</code></pre><pre class=\"r-output\"><code>Fitting model 5 out of 5\n</code></pre><pre class=\"r-output\"><code>-----\n-----\nRunning the search and the performance evaluation with `refit_prj = TRUE` for each of the K = 5 CV folds separately ...\n\n  |                                                                            \n  |                                                                      |   0%\n  |                                                                            \n  |==============                                                        |  20%\n  |                                                                            \n  |============================                                          |  40%\n  |                                                                            \n  |==========================================                            |  60%\n  |                                                                            \n  |========================================================              |  80%\n  |                                                                            \n  |======================================================================| 100%\n-----\n</code></pre>\n\n```{.r .cell-code}\nrk <- projpred::ranking(cvvs)\n\nn_var_select <- projpred::suggest_size(cvvs)\nn_var_select <- max(1, n_var_select) # At least exposure metric should be included\n\nvar_selected <- head(rk[[\"fulldata\"]], n_var_select)\n```\n:::\n\n\n\n\n#### Output\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nvar_selected\n```\n\n<pre class=\"r-output\"><code>[1] \"AUCss_1000\" \"BHBA1C_5\"   \"BGLUC\"     \n</code></pre>\n\n```{.r .cell-code}\nplot(cvvs, text_angle = 45, show_cv_proportions = FALSE, deltas = TRUE)\nplot(rk) # This only works when cv_method = \"kfold\" and validate_search = TRUE\n```\n\n::: {.cell-output-display}\n![](workflow_wo_package_files/figure-html/fig-covsel-1.png){#fig-covsel-1 width=672}\n:::\n\n::: {.cell-output-display}\n![](workflow_wo_package_files/figure-html/fig-covsel-2.png){#fig-covsel-2 width=672}\n:::\n:::\n\n\n\n\n\n### Step 3: Final model fit\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nset.seed(1234)\n\nermod_bin_cov <- rstanarm::stan_glm(\n  stats::formula(glue::glue(\n    \"{var_resp} ~ {paste(var_selected, collapse = ' + ')}\"\n  )),\n  family = stats::binomial(),\n  data = df_er_ae_hgly2,\n  QR = dplyr::if_else(length(var_selected) > 1, TRUE, FALSE),\n  refresh = 0, # Suppress output\n)\n\nermod_bin_cov\n```\n\n<pre class=\"r-output\"><code>stan_glm\n family:       binomial [logit]\n formula:      AEFLAG ~ AUCss_1000 + BHBA1C_5 + BGLUC\n observations: 500\n predictors:   4\n------\n            Median MAD_SD\n(Intercept) -11.0    1.2 \nAUCss_1000    0.5    0.1 \nBHBA1C_5      0.5    0.1 \nBGLUC         0.7    0.1 \n\n------\n* For help interpreting the printed output see ?print.stanreg\n* For info on the priors used see ?prior_summary.stanreg\n</code></pre>\n:::\n\n\n\n\n## Marginal ER prediction\n\nThe example below simulate the marginal ER relationship, i.e. \nER relationships for \"marginalized\", or averaged, response for the population \nof interest, using the covariate distribution is from the original data.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nexposure_to_sim <- c(2:6)\n\ndata_cov <- df_er_ae_hgly2 |> select(-!!var_exposure)\n\ndata_for_sim <-\n  tibble(!!var_exposure := exposure_to_sim) |>\n  mutate(.id_exposure = row_number()) |>\n  expand_grid(data_cov)\n\nsim_epred_raw <-\n  tidybayes::add_epred_draws(data_for_sim, ermod_bin_cov)\n\n# Calculate marginal expected response for each exposure value and draw\nsim_epred_marg <-\n  sim_epred_raw |>\n  dplyr::ungroup() |>\n  dplyr::summarize(\n    .epred = mean(.epred),\n    .by = c(.id_exposure, !!var_exposure, .draw)\n  )\n\nsim_epred_marg_med_qi <-\n  sim_epred_marg |>\n  dplyr::group_by(.id_exposure, !!sym(var_exposure)) |>\n  tidybayes::median_qi() |>\n  dplyr::as_tibble()\n\nsim_epred_marg_med_qi |>\n  gt::gt() |>\n  gt::fmt_number(n_sigfig = 3) |>\n  gt::fmt_integer(columns = c(\".id_exposure\"))\n```\n\n::: {#fig-marginal-er .cell-output-display}\n`````{=html}\n<pre class=\"r-output\"><code>\n```{=html}\n<div id=\"qnnknajtwb\" style=\"padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;\">\n<style>#qnnknajtwb table {\n  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';\n  -webkit-font-smoothing: antialiased;\n  -moz-osx-font-smoothing: grayscale;\n}\n\n#qnnknajtwb thead, #qnnknajtwb tbody, #qnnknajtwb tfoot, #qnnknajtwb tr, #qnnknajtwb td, #qnnknajtwb th {\n  border-style: none;\n}\n\n#qnnknajtwb p {\n  margin: 0;\n  padding: 0;\n}\n\n#qnnknajtwb .gt_table {\n  display: table;\n  border-collapse: collapse;\n  line-height: normal;\n  margin-left: auto;\n  margin-right: auto;\n  color: #333333;\n  font-size: 16px;\n  font-weight: normal;\n  font-style: normal;\n  background-color: #FFFFFF;\n  width: auto;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #A8A8A8;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #A8A8A8;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n}\n\n#qnnknajtwb .gt_caption {\n  padding-top: 4px;\n  padding-bottom: 4px;\n}\n\n#qnnknajtwb .gt_title {\n  color: #333333;\n  font-size: 125%;\n  font-weight: initial;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-color: #FFFFFF;\n  border-bottom-width: 0;\n}\n\n#qnnknajtwb .gt_subtitle {\n  color: #333333;\n  font-size: 85%;\n  font-weight: initial;\n  padding-top: 3px;\n  padding-bottom: 5px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-color: #FFFFFF;\n  border-top-width: 0;\n}\n\n#qnnknajtwb .gt_heading {\n  background-color: #FFFFFF;\n  text-align: center;\n  border-bottom-color: #FFFFFF;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#qnnknajtwb .gt_bottom_border {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#qnnknajtwb .gt_col_headings {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#qnnknajtwb .gt_col_heading {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 6px;\n  padding-left: 5px;\n  padding-right: 5px;\n  overflow-x: hidden;\n}\n\n#qnnknajtwb .gt_column_spanner_outer {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  padding-top: 0;\n  padding-bottom: 0;\n  padding-left: 4px;\n  padding-right: 4px;\n}\n\n#qnnknajtwb .gt_column_spanner_outer:first-child {\n  padding-left: 0;\n}\n\n#qnnknajtwb .gt_column_spanner_outer:last-child {\n  padding-right: 0;\n}\n\n#qnnknajtwb .gt_column_spanner {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 5px;\n  overflow-x: hidden;\n  display: inline-block;\n  width: 100%;\n}\n\n#qnnknajtwb .gt_spanner_row {\n  border-bottom-style: hidden;\n}\n\n#qnnknajtwb .gt_group_heading {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  text-align: left;\n}\n\n#qnnknajtwb .gt_empty_group_heading {\n  padding: 0.5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: middle;\n}\n\n#qnnknajtwb .gt_from_md > :first-child {\n  margin-top: 0;\n}\n\n#qnnknajtwb .gt_from_md > :last-child {\n  margin-bottom: 0;\n}\n\n#qnnknajtwb .gt_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  margin: 10px;\n  border-top-style: solid;\n  border-top-width: 1px;\n  border-top-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  overflow-x: hidden;\n}\n\n#qnnknajtwb .gt_stub {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#qnnknajtwb .gt_stub_row_group {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n  vertical-align: top;\n}\n\n#qnnknajtwb .gt_row_group_first td {\n  border-top-width: 2px;\n}\n\n#qnnknajtwb .gt_row_group_first th {\n  border-top-width: 2px;\n}\n\n#qnnknajtwb .gt_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#qnnknajtwb .gt_first_summary_row {\n  border-top-style: solid;\n  border-top-color: #D3D3D3;\n}\n\n#qnnknajtwb .gt_first_summary_row.thick {\n  border-top-width: 2px;\n}\n\n#qnnknajtwb .gt_last_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#qnnknajtwb .gt_grand_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#qnnknajtwb .gt_first_grand_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-style: double;\n  border-top-width: 6px;\n  border-top-color: #D3D3D3;\n}\n\n#qnnknajtwb .gt_last_grand_summary_row_top {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-style: double;\n  border-bottom-width: 6px;\n  border-bottom-color: #D3D3D3;\n}\n\n#qnnknajtwb .gt_striped {\n  background-color: rgba(128, 128, 128, 0.05);\n}\n\n#qnnknajtwb .gt_table_body {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#qnnknajtwb .gt_footnotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#qnnknajtwb .gt_footnote {\n  margin: 0px;\n  font-size: 90%;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#qnnknajtwb .gt_sourcenotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#qnnknajtwb .gt_sourcenote {\n  font-size: 90%;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#qnnknajtwb .gt_left {\n  text-align: left;\n}\n\n#qnnknajtwb .gt_center {\n  text-align: center;\n}\n\n#qnnknajtwb .gt_right {\n  text-align: right;\n  font-variant-numeric: tabular-nums;\n}\n\n#qnnknajtwb .gt_font_normal {\n  font-weight: normal;\n}\n\n#qnnknajtwb .gt_font_bold {\n  font-weight: bold;\n}\n\n#qnnknajtwb .gt_font_italic {\n  font-style: italic;\n}\n\n#qnnknajtwb .gt_super {\n  font-size: 65%;\n}\n\n#qnnknajtwb .gt_footnote_marks {\n  font-size: 75%;\n  vertical-align: 0.4em;\n  position: initial;\n}\n\n#qnnknajtwb .gt_asterisk {\n  font-size: 100%;\n  vertical-align: 0;\n}\n\n#qnnknajtwb .gt_indent_1 {\n  text-indent: 5px;\n}\n\n#qnnknajtwb .gt_indent_2 {\n  text-indent: 10px;\n}\n\n#qnnknajtwb .gt_indent_3 {\n  text-indent: 15px;\n}\n\n#qnnknajtwb .gt_indent_4 {\n  text-indent: 20px;\n}\n\n#qnnknajtwb .gt_indent_5 {\n  text-indent: 25px;\n}\n\n#qnnknajtwb .katex-display {\n  display: inline-flex !important;\n  margin-bottom: 0.75em !important;\n}\n\n#qnnknajtwb div.Reactable > div.rt-table > div.rt-thead > div.rt-tr.rt-tr-group-header > div.rt-th-group:after {\n  height: 0px !important;\n}\n</style>\n<table class=\"gt_table\" data-quarto-disable-processing=\"false\" data-quarto-bootstrap=\"false\">\n  <thead>\n    <tr class=\"gt_col_headings\">\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"a.id_exposure\">.id_exposure</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"AUCss_1000\">AUCss_1000</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"a.epred\">.epred</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"a.lower\">.lower</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"a.upper\">.upper</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"a.width\">.width</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_left\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"a.point\">.point</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_left\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"a.interval\">.interval</th>\n    </tr>\n  </thead>\n  <tbody class=\"gt_table_body\">\n    <tr><td headers=\".id_exposure\" class=\"gt_row gt_right\">1</td>\n<td headers=\"AUCss_1000\" class=\"gt_row gt_right\">2.00</td>\n<td headers=\".epred\" class=\"gt_row gt_right\">0.228</td>\n<td headers=\".lower\" class=\"gt_row gt_right\">0.192</td>\n<td headers=\".upper\" class=\"gt_row gt_right\">0.267</td>\n<td headers=\".width\" class=\"gt_row gt_right\">0.950</td>\n<td headers=\".point\" class=\"gt_row gt_left\">median</td>\n<td headers=\".interval\" class=\"gt_row gt_left\">qi</td></tr>\n    <tr><td headers=\".id_exposure\" class=\"gt_row gt_right\">2</td>\n<td headers=\"AUCss_1000\" class=\"gt_row gt_right\">3.00</td>\n<td headers=\".epred\" class=\"gt_row gt_right\">0.307</td>\n<td headers=\".lower\" class=\"gt_row gt_right\">0.268</td>\n<td headers=\".upper\" class=\"gt_row gt_right\">0.347</td>\n<td headers=\".width\" class=\"gt_row gt_right\">0.950</td>\n<td headers=\".point\" class=\"gt_row gt_left\">median</td>\n<td headers=\".interval\" class=\"gt_row gt_left\">qi</td></tr>\n    <tr><td headers=\".id_exposure\" class=\"gt_row gt_right\">3</td>\n<td headers=\"AUCss_1000\" class=\"gt_row gt_right\">4.00</td>\n<td headers=\".epred\" class=\"gt_row gt_right\">0.396</td>\n<td headers=\".lower\" class=\"gt_row gt_right\">0.341</td>\n<td headers=\".upper\" class=\"gt_row gt_right\">0.455</td>\n<td headers=\".width\" class=\"gt_row gt_right\">0.950</td>\n<td headers=\".point\" class=\"gt_row gt_left\">median</td>\n<td headers=\".interval\" class=\"gt_row gt_left\">qi</td></tr>\n    <tr><td headers=\".id_exposure\" class=\"gt_row gt_right\">4</td>\n<td headers=\"AUCss_1000\" class=\"gt_row gt_right\">5.00</td>\n<td headers=\".epred\" class=\"gt_row gt_right\">0.491</td>\n<td headers=\".lower\" class=\"gt_row gt_right\">0.409</td>\n<td headers=\".upper\" class=\"gt_row gt_right\">0.576</td>\n<td headers=\".width\" class=\"gt_row gt_right\">0.950</td>\n<td headers=\".point\" class=\"gt_row gt_left\">median</td>\n<td headers=\".interval\" class=\"gt_row gt_left\">qi</td></tr>\n    <tr><td headers=\".id_exposure\" class=\"gt_row gt_right\">5</td>\n<td headers=\"AUCss_1000\" class=\"gt_row gt_right\">6.00</td>\n<td headers=\".epred\" class=\"gt_row gt_right\">0.588</td>\n<td headers=\".lower\" class=\"gt_row gt_right\">0.477</td>\n<td headers=\".upper\" class=\"gt_row gt_right\">0.692</td>\n<td headers=\".width\" class=\"gt_row gt_right\">0.950</td>\n<td headers=\".point\" class=\"gt_row gt_left\">median</td>\n<td headers=\".interval\" class=\"gt_row gt_left\">qi</td></tr>\n  </tbody>\n  \n  \n</table>\n</div>\n```\n</code></pre>\n`````\n:::\n:::\n",
    "supporting": [
      "workflow_wo_package_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}