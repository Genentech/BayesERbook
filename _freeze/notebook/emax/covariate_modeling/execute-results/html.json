{
  "hash": "f5dac2ddb09d65e2ceab2d300cb348fd",
  "result": {
    "engine": "knitr",
    "markdown": "# Covariate modeling with brms\n\nThe previous chapter introduced the brms approach to Bayesian E~max~ modeling, with examples provided for hyperbolic and sigmoidal E~max~ models, and considering both continuous and binary outcomes. This chapter extends this by building models that include covariates, and shows examples of model comparison using leave-one-out cross-validation (LOO-CV).\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(brms)\nlibrary(posterior)\nlibrary(tidybayes)\nlibrary(here)\n\ntheme_set(theme_bw(base_size = 12))\n```\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nif (require(cmdstanr)) {\n  # prefer cmdstanr and cache binaries\n  options(\n    brms.backend = \"cmdstanr\", \n    cmdstanr_write_stan_file_dir = here(\"_brms-cache\")\n  )\n  dir.create(here(\"_brms-cache\"), FALSE)\n} else {\n  rstan::rstan_options(auto_write = TRUE)\n}\n```\n\n<pre class=\"r-output\"><code>Loading required package: cmdstanr\n</code></pre><pre class=\"r-output\"><code>This is cmdstanr version 0.9.0\n</code></pre><pre class=\"r-output\"><code>- CmdStanR documentation and vignettes: mc-stan.org/cmdstanr\n</code></pre><pre class=\"r-output\"><code>- CmdStan path: /home/danielle/.cmdstan/cmdstan-2.36.0\n</code></pre><pre class=\"r-output\"><code>- CmdStan version: 2.36.0\n</code></pre>\n:::\n\n\n\n\n\n## Continuous response with covariates\n\nThe simulated data set contains three continuous covariates (`cov_a`, `cov_b`, and `cov_c`) that may be related to `response`. The univariate relationships between each covariate and the response are shown below, along with the relationship between `exposure` and `reponse`: \n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nd_example_emax_3cov <- read_csv(here(\"data\", \"d_example_emax_3cov.csv\"))\n\nd_example_emax_3cov |> \n  pivot_longer(\n    cols = c(exposure, cov_a, cov_b, cov_c), \n    names_to = \"variable\",\n    values_to = \"value\"\n  ) |> \n  ggplot(aes(value, response)) + \n  geom_point() + \n  geom_smooth(formula = y ~ x, method = \"loess\") + \n  facet_wrap(~ variable, scales = \"free_x\")\n```\n\n::: {.cell-output-display}\n![](covariate_modeling_files/figure-html/show-continuous-emax-data-1.png){width=768}\n:::\n:::\n\n\n\n\n\nIn the brms framework, the E~max~ function is treated as a structural model and covariates can be placed on any parameter when the model is specified using `brmsformula()`. As an example, the model specified here sets `cov_a`, `cov_b`, and `cov_c` as covariates on the baseline response:\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncovariate_model <- brmsformula(\n  response ~ e0 + emax * exposure / (ec50 + exposure), # structural model\n  e0   ~ 1 + cov_a + cov_b + cov_c, # covariate model for baseline\n  emax ~ 1,                         # covariate model for max response\n  ec50 ~ 1,                         # covariate model for EC50\n  nl = TRUE\n)\n```\n:::\n\n\n\n\n\nThe measurement model and parameter prior are specified using `brmsfamily()` and `prior()`, and are the same as for the model without covariates:\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ngaussian_measurement <- brmsfamily(\n  family = \"gaussian\", \n  link = \"identity\"\n)\n\nparameter_prior <- c(\n  prior(normal(0, 1.5), nlpar = \"e0\"),\n  prior(normal(0, 1.5), nlpar = \"emax\"),\n  prior(normal(2000, 500), nlpar = \"ec50\", lb = 0)\n)\n```\n:::\n\n\n\n\n\nWhen interpreting the prior, it is important to remember that there are covariates on `e0`: the `normal(0, 1.5)` prior is applied to all regression coefficients. That means that this prior is applied independently to `e0_Intercept`, `e0_cov_a`, `e0_cov_b`, and `e0_cov_c`. \n\nTo apply this model to the continuous data, pass all three of these to `brm()`:\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncontinuous_covariate_fit <- brm(\n  formula = covariate_model, \n  family = gaussian_measurement, \n  data = d_example_emax_3cov, \n  prior = parameter_prior\n) \n```\n:::\n\n\n\n\n\nPrinting the `continuous_covariate_fit` object provides summary information about the regression coefficients for the covariates and other parameters:\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncontinuous_covariate_fit\n```\n\n<pre class=\"r-output\"><code> Family: gaussian \n  Links: mu = identity; sigma = identity \nFormula: response ~ e0 + emax * exposure/(ec50 + exposure) \n         e0 ~ 1 + cov_a + cov_b + cov_c\n         emax ~ 1\n         ec50 ~ 1\n   Data: d_example_emax_3cov (Number of observations: 300) \n  Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;\n         total post-warmup draws = 4000\n\nRegression Coefficients:\n               Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS\ne0_Intercept       3.92      0.48     2.93     4.82 1.00     1587     2164\ne0_cov_a           0.52      0.01     0.49     0.54 1.00     3078     2500\ne0_cov_b           0.01      0.01    -0.01     0.04 1.00     3046     2655\ne0_cov_c          -0.00      0.01    -0.03     0.02 1.00     3392     2810\nemax_Intercept    10.67      0.43     9.85    11.53 1.00     1687     2375\nec50_Intercept  3151.95    282.74  2627.99  3719.94 1.00     1700     2237\n\nFurther Distributional Parameters:\n      Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS\nsigma     0.52      0.02     0.48     0.57 1.00     3309     2507\n\nDraws were sampled using sample(hmc). For each parameter, Bulk_ESS\nand Tail_ESS are effective sample size measures, and Rhat is the potential\nscale reduction factor on split chains (at convergence, Rhat = 1).\n</code></pre>\n:::\n\n\n\n\n\nExtending the data visualization used earlier, the model predictions can be plotted as a function of both `exposure` and `cov_a`:\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncov_a_map <- \n  tibble(\n    cov_a = c(2, 5, 8),\n    cov_a_group = c(\"2 (<3.5)\", \"5 (3.5~6.5)\", \"8 (â‰¥6.5)\")\n  )\n\nsim_exposure_cov_a <- \n  continuous_covariate_fit |> \n  epred_draws(newdata = expand_grid(\n    exposure = seq(0, 50000, 1000),\n    cov_a = c(2, 5, 8), \n    cov_b = 5,\n    cov_c = 5\n  )) |> \n  median_qi() |> \n  left_join(cov_a_map, by = join_by(cov_a))\n\nd_for_plot <- \n  d_example_emax_3cov |> \n  mutate(\n    cov_a_raw = cov_a,\n    cov_a = case_when(\n      cov_a < 3.5 ~ 2,\n      cov_a >= 3.5 & cov_a < 6.5 ~ 5,\n      cov_a >= 6.5 ~ 8\n    )\n  ) |> \n  left_join(cov_a_map, by = join_by(cov_a))\n\nsim_exposure_cov_a |> \n  ggplot(mapping = aes(exposure, .epred)) + \n  geom_path() + \n  geom_ribbon(\n    mapping = aes(ymin = .lower, ymax = .upper), \n    alpha = 0.3\n  ) +\n  geom_point(\n    data = d_for_plot,\n    mapping = aes(y = response, color = cov_a_raw)\n  ) + \n  facet_wrap(~cov_a_group, labeller = label_both) +\n  labs(color = \"cov_a\") + \n  theme(legend.position = \"bottom\")\n```\n\n::: {.cell-output-display}\n![](covariate_modeling_files/figure-html/unnamed-chunk-9-1.png){width=672}\n:::\n:::\n\n\n\n\n\n## Binary response with covariates\n\nBuilding a covariate model for binary response data follows the same process as for continuous response data. As before, exploratory visualizations are helpful in illustrating the relationships between covariates and the response:\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nd_example_emax_bin_3cov <- read_csv(here(\"data\", \"d_example_emax_bin_3cov.csv\"))\n\nd_example_emax_bin_3cov |> \n  pivot_longer(\n    cols = c(exposure, cov_a, cov_b, cov_c), \n    names_to = \"variable\",\n    values_to = \"value\"\n  ) |> \n  mutate(response = factor(response)) |> \n  ggplot(aes(response, value)) + \n  geom_violin(draw_quantiles = .5) + \n  facet_wrap(~ variable, scales = \"free_y\")\n```\n\n::: {.cell-output-display}\n![](covariate_modeling_files/figure-html/show-binary-emax-data-1.png){width=768}\n:::\n:::\n\n\n\n\n\nAs in the previous chapter, the only difference between the binary model and the continuous model is the use of the `bernoulli_measurement` model:\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbernoulli_measurement <- brmsfamily(\n  family = \"bernoulli\", \n  link = \"logit\"\n)\n```\n:::\n\n\n\n\n\nThe `parameter_prior` and `covariate_model` are the same as before. All three are passed to `brm()`, as shown below: \n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbinary_covariate_fit <- brm(\n  formula = covariate_model, \n  family = bernoulli_measurement, \n  data = d_example_emax_bin_3cov, \n  prior = parameter_prior\n) \n```\n:::\n\n\n\n\n\nAfter the sampling finishes, printing the model fit object shows parameter estimates and details about the behavior of the sampler:\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbinary_covariate_fit\n```\n\n<pre class=\"r-output\"><code> Family: bernoulli \n  Links: mu = logit \nFormula: response ~ e0 + emax * exposure/(ec50 + exposure) \n         e0 ~ 1 + cov_a + cov_b + cov_c\n         emax ~ 1\n         ec50 ~ 1\n   Data: d_example_emax_bin_3cov (Number of observations: 300) \n  Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;\n         total post-warmup draws = 4000\n\nRegression Coefficients:\n               Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS\ne0_Intercept      -2.06      0.86    -3.80    -0.41 1.00     2047     2076\ne0_cov_a           0.22      0.07     0.09     0.35 1.00     3228     2670\ne0_cov_b          -0.02      0.06    -0.15     0.10 1.00     4227     2524\ne0_cov_c          -0.03      0.06    -0.15     0.09 1.00     3337     2706\nemax_Intercept     3.40      0.90     1.62     5.17 1.00     2869     2803\nec50_Intercept  2451.78    452.04  1580.53  3333.24 1.00     3934     2231\n\nDraws were sampled using sample(hmc). For each parameter, Bulk_ESS\nand Tail_ESS are effective sample size measures, and Rhat is the potential\nscale reduction factor on split chains (at convergence, Rhat = 1).\n</code></pre>\n:::\n\n\n\n\n\nThe data visualization for this model is shown below:\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncov_a_map <- \n  tibble(\n    cov_a = c(2, 5, 8),\n    cov_a_group = c(\"2 (<3.5)\", \"5 (3.5~6.5)\", \"8 (â‰¥6.5)\")\n  )\n\nsim_exposure_cov_a <- \n  binary_covariate_fit |> \n  epred_draws(newdata = expand_grid(\n    exposure = seq(0, 50000, 1000),\n    cov_a = c(2, 5, 8), \n    cov_b = 5,\n    cov_c = 5\n  )) |> \n  median_qi() |> \n  left_join(cov_a_map, by = join_by(cov_a))\n\nd_for_plot <- \n  d_example_emax_bin_3cov |> \n  mutate(\n    cov_a_raw = cov_a,\n    cov_a = case_when(\n      cov_a < 3.5 ~ 2,\n      cov_a >= 3.5 & cov_a < 6.5 ~ 5,\n      cov_a >= 6.5 ~ 8\n    )\n  ) |> \n  left_join(cov_a_map, by = join_by(cov_a))\n\nsim_exposure_cov_a |> \n  ggplot(mapping = aes(exposure, .epred)) + \n  geom_path() + \n  geom_ribbon(\n    mapping = aes(ymin = .lower, ymax = .upper), \n    alpha = 0.3\n  ) +\n  geom_jitter(\n    data = d_for_plot,\n    mapping = aes(y = response, color = cov_a_raw),\n    width = 0,\n    height = .05\n  ) + \n  facet_wrap(~cov_a_group, labeller = label_both) +\n  labs(color = \"cov_a\") + \n  theme(legend.position = \"bottom\")\n```\n\n::: {.cell-output-display}\n![](covariate_modeling_files/figure-html/unnamed-chunk-14-1.png){width=672}\n:::\n:::\n\n\n\n\n\n## Setting covariates on other parameters\n\nThe previous two examples illustrate covariates placed on the intercept parameter `e0`. It is possible to define covariate models on any parameter within the E~max~ model. \n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nother_covariates <- brmsformula(\n  response ~ e0 + emax * exposure / (ec50 + exposure), # structural model\n  e0   ~ 1 + cov_a,   # covariate model for baseline\n  emax ~ 1 + cov_b,   # covariate model for max response\n  ec50 ~ 1,           # covariate model for EC50\n  nl = TRUE\n)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nother_covariates_fit <- brm(\n  formula = other_covariates, \n  family = gaussian_measurement, \n  data = d_example_emax_3cov, \n  prior = parameter_prior\n) \n```\n:::\n\n\n\n\n\nPrinting the `other_covariates_fit` object provides summary information:\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nother_covariates_fit\n```\n\n<pre class=\"r-output\"><code> Family: gaussian \n  Links: mu = identity; sigma = identity \nFormula: response ~ e0 + emax * exposure/(ec50 + exposure) \n         e0 ~ 1 + cov_a\n         emax ~ 1 + cov_b\n         ec50 ~ 1\n   Data: d_example_emax_3cov (Number of observations: 300) \n  Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;\n         total post-warmup draws = 4000\n\nRegression Coefficients:\n               Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS\ne0_Intercept       3.97      0.50     2.98     4.90 1.00     1145     1572\ne0_cov_a           0.52      0.01     0.49     0.54 1.00     2584     2219\nemax_Intercept    10.55      0.47     9.65    11.49 1.00     1222     1569\nemax_cov_b         0.03      0.02    -0.01     0.06 1.00     2951     2598\nec50_Intercept  3147.49    294.61  2608.48  3770.72 1.00     1222     1734\n\nFurther Distributional Parameters:\n      Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS\nsigma     0.52      0.02     0.48     0.57 1.00     2581     2106\n\nDraws were sampled using sample(hmc). For each parameter, Bulk_ESS\nand Tail_ESS are effective sample size measures, and Rhat is the potential\nscale reduction factor on split chains (at convergence, Rhat = 1).\n</code></pre>\n:::\n\n\n\n\n\n## Model comparison\n\nThe brms package provides a flexible interface for model comparison using LOO-CV and WAIC, using the [loo](http://mc-stan.org/loo/) package internally. One workflow for calling this interface is illustrated in this section, using the three possible E~max~ models as examples: \n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# no covariates\nbase_model <- brmsformula(\n  response ~ e0 + emax * exposure / (ec50 + exposure),\n  e0   ~ 1,\n  emax ~ 1,\n  ec50 ~ 1,\n  nl = TRUE\n)\n\n# one predictor on e0\ncov_a_model <- brmsformula(\n  response ~ e0 + emax * exposure / (ec50 + exposure),\n  e0   ~ 1 + cov_a,\n  emax ~ 1,\n  ec50 ~ 1,\n  nl = TRUE\n)\n\n# three predictors on e0\ncov_abc_model <- brmsformula(\n  response ~ e0 + emax * exposure / (ec50 + exposure),\n  e0   ~ 1 + cov_a + cov_b + cov_c,\n  emax ~ 1,\n  ec50 ~ 1,\n  nl = TRUE\n)\n```\n:::\n\n\n\n\n\nIn addition to calling `brm()` to estimate regression coefficients, the `add_criterion()` function is called to run the LOO-CV procedure and store the results internally within the brmsfit object:\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbase_fit <- base_model |> \n  brm(  \n    family = gaussian_measurement, \n    data = d_example_emax_3cov, \n    prior = parameter_prior\n  ) |> \n  add_criterion(\"loo\")\n  \ncov_a_fit <- cov_a_model |> \n  brm(\n    family = gaussian_measurement, \n    data = d_example_emax_3cov, \n    prior = parameter_prior\n  ) |> \n  add_criterion(\"loo\")\n\ncov_abc_fit <- cov_abc_model |> \n  brm(\n    family = gaussian_measurement, \n    data = d_example_emax_3cov, \n    prior = parameter_prior\n  ) |> \n  add_criterion(\"loo\")\n```\n:::\n\n\n\n\n\nTo compare models that have LOO criteria information added, use `loo_compare()`:\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmodel_comparison <- loo_compare(\n  base_fit,\n  cov_a_fit,\n  cov_abc_fit\n)\n\nmodel_comparison\n```\n\n<pre class=\"r-output\"><code>            elpd_diff se_diff\ncov_a_fit      0.0       0.0 \ncov_abc_fit   -1.6       1.1 \nbase_fit    -269.5      14.5 \n</code></pre>\n:::\n\n\n\n\n\nIn this example, `cov_a_fit` model outperforms the other two models. \n\nBy default the printed output shows the most important columns, but the return value from `loo_compare()` contains additional information relevant to the model comparison. To view all columns, call the print method with `simplify = FALSE`:\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nprint(model_comparison, simplify = FALSE)\n```\n\n<pre class=\"r-output\"><code>            elpd_diff se_diff elpd_loo se_elpd_loo p_loo  se_p_loo looic \ncov_a_fit      0.0       0.0  -233.1     12.5         4.1    0.5    466.1\ncov_abc_fit   -1.6       1.1  -234.7     12.5         6.1    0.6    469.4\nbase_fit    -269.5      14.5  -502.6     10.7         2.7    0.2   1005.1\n            se_looic\ncov_a_fit     24.9  \ncov_abc_fit   25.0  \nbase_fit      21.4  \n</code></pre>\n:::\n",
    "supporting": [
      "covariate_modeling_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}