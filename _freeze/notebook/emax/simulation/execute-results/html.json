{
  "hash": "14e0e0a80d8ae1840ad39a7b9ca70cc0",
  "result": {
    "engine": "knitr",
    "markdown": "# Simulation from fitted model\n\nThis page showcase the model simulation using the E~max~ model with no covariate.\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(BayesERtools)\nlibrary(posterior)\nlibrary(tidybayes)\nlibrary(bayesplot)\nlibrary(loo)\nlibrary(here)\nlibrary(gt)\n\ntheme_set(theme_bw(base_size = 12))\n```\n:::\n\n\n\n\n\n\n\n## Load data\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nd_sim_emax\n```\n\n<pre class=\"r-output\"><code><span style='color: #555555;'># A tibble: 300 × 9</span>\n    dose exposure response_1 response_2 cnt_a cnt_b cnt_c bin_d bin_e\n   <span style='color: #555555; font-style: italic;'><dbl></span>    <span style='color: #555555; font-style: italic;'><dbl></span>      <span style='color: #555555; font-style: italic;'><dbl></span>      <span style='color: #555555; font-style: italic;'><dbl></span> <span style='color: #555555; font-style: italic;'><dbl></span> <span style='color: #555555; font-style: italic;'><dbl></span> <span style='color: #555555; font-style: italic;'><dbl></span> <span style='color: #555555; font-style: italic;'><dbl></span> <span style='color: #555555; font-style: italic;'><dbl></span>\n<span style='color: #555555;'> 1</span>   100    <span style='text-decoration: underline;'>4</span>151.       12.8          1  5.71  2.33  7.83     0     1\n<span style='color: #555555;'> 2</span>   100    <span style='text-decoration: underline;'>8</span>067.       14.6          1  4.92  4.66  6.74     1     1\n<span style='color: #555555;'> 3</span>   100    <span style='text-decoration: underline;'>4</span>878.       12.8          1  4.88  4.21  4.68     1     1\n<span style='color: #555555;'> 4</span>   100    <span style='text-decoration: underline;'>9</span>713.       16.6          1  8.42  6.56  1.29     0     1\n<span style='color: #555555;'> 5</span>   100   <span style='text-decoration: underline;'>11</span>491.       14.4          0  4.37  3.96  3.55     0     1\n<span style='color: #555555;'> 6</span>   100    <span style='text-decoration: underline;'>2</span>452.       12.6          1  8.69  7.60  3.64     0     0\n<span style='color: #555555;'> 7</span>   100    <span style='text-decoration: underline;'>5</span>652.       14.8          1  6.61  3.95  5.13     0     0\n<span style='color: #555555;'> 8</span>   100    <span style='text-decoration: underline;'>9</span>939.       15.2          1  5.35  7.77  8.29     0     1\n<span style='color: #555555;'> 9</span>   100    <span style='text-decoration: underline;'>5</span>817.       14.6          0  5.61  2.24  9.60     0     1\n<span style='color: #555555;'>10</span>   100    <span style='text-decoration: underline;'>5</span>176.       13.7          1  6.06  1.79  8.74     0     1\n<span style='color: #555555;'># ℹ 290 more rows</span>\n</code></pre>\n:::\n\n\n\n\n\n## Fit models\n\n::: {.panel-tabset}\n\n### Sigmoidal E~max~ model\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nset.seed(1234)\n\nermod_sigemax <- dev_ermod_emax(\n  data = d_sim_emax,\n  var_resp = \"response_1\",\n  var_exposure = \"exposure\",\n  gamma_fix = NULL\n)\n\nermod_sigemax\n```\n\n<pre class=\"r-output\"><code>\n<span style='color: #00BBBB;'>──</span> <span style='font-weight: bold;'>Emax model</span> <span style='color: #00BBBB;'>──────────────────────────────────────────────────────────────────</span>\n<span style='color: #00BBBB;'>ℹ</span> Use `plot_er()` to visualize ER curve\n\n── <span style='font-weight: bold;'>Developed model</span> ──\n\n---- Emax model fit with rstanemax ----\n         mean se_mean      sd   2.5%     25%     50%     75%    97.5%   n_eff\nemax    11.59    0.31    5.89   4.82    7.34   10.10   14.24    27.50  368.24\ne0       6.68    0.20    4.08  -3.67    4.78    7.68    9.71    11.48  436.14\nec50  5254.72  193.00 4475.71 801.17 2974.18 4673.97 6385.68 15736.00  537.81\ngamma    1.06    0.02    0.50   0.32    0.70    0.97    1.33     2.26  543.20\nsigma    1.27    0.00    0.05   1.18    1.24    1.27    1.31     1.39 1375.87\n      Rhat\nemax  1.01\ne0    1.01\nec50  1.00\ngamma 1.01\nsigma 1.00\n* Use `extract_stanfit()` function to extract raw stanfit object\n* Use `extract_param()` function to extract posterior draws of key parameters\n* Use `plot()` function to visualize model fit\n* Use `posterior_predict()` or `posterior_predict_quantile()` function to get\n  raw predictions or make predictions on new data\n* Use `extract_obs_mod_frame()` function to extract raw data \n  in a processed format (useful for plotting)\n</code></pre>\n:::\n\n\n\n\n\n### Regular E~max~ (h fixed at 1)\n\nAnother model without sigmoidal component; will be used when we do\nmodel comparison.\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nset.seed(1234)\n\nermod_emax <- dev_ermod_emax(\n  data = d_sim_emax,\n  var_resp = \"response_1\",\n  var_exposure = \"exposure\",\n  gamma_fix = 1\n)\n\nermod_emax\n```\n\n<pre class=\"r-output\"><code>\n<span style='color: #00BBBB;'>──</span> <span style='font-weight: bold;'>Emax model</span> <span style='color: #00BBBB;'>──────────────────────────────────────────────────────────────────</span>\n<span style='color: #00BBBB;'>ℹ</span> Use `plot_er()` to visualize ER curve\n\n── <span style='font-weight: bold;'>Developed model</span> ──\n\n---- Emax model fit with rstanemax ----\n         mean se_mean      sd    2.5%     25%     50%     75%   97.5%   n_eff\nemax    10.11    0.07    1.71    7.93    8.98    9.72   10.81   14.42  564.00\ne0       7.32    0.08    2.00    2.41    6.41    7.66    8.70   10.13  572.38\nec50  4341.84   62.80 1871.39 1704.41 3062.61 3994.85 5323.78 9061.88  887.87\ngamma    1.00     NaN    0.00    1.00    1.00    1.00    1.00    1.00     NaN\nsigma    1.28    0.00    0.05    1.18    1.24    1.27    1.31    1.39 1440.04\n      Rhat\nemax  1.01\ne0    1.01\nec50  1.00\ngamma  NaN\nsigma 1.00\n* Use `extract_stanfit()` function to extract raw stanfit object\n* Use `extract_param()` function to extract posterior draws of key parameters\n* Use `plot()` function to visualize model fit\n* Use `posterior_predict()` or `posterior_predict_quantile()` function to get\n  raw predictions or make predictions on new data\n* Use `extract_obs_mod_frame()` function to extract raw data \n  in a processed format (useful for plotting)\n</code></pre>\n:::\n\n\n\n\n\n:::\n\n# Extrapolation \n\n::: {.panel-tabset}\n\n## without residual error\n\nThis represents uncertainty in the model parameters.\n\n- `p(f(theta)|xnew, yobs)`\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nnew_conc_vec <- seq(0, 70000, by = 500)\n\nersim_sigemax <-\n  sim_er_new_exp(ermod_sigemax, new_conc_vec)\n\nersim_sigemax_med_qi <-\n  ersim_sigemax |>\n  calc_ersim_med_qi(qi_width = c(0.5, 0.95))\n\nggplot(\n  data = ersim_sigemax_med_qi, \n  mapping = aes(x = exposure, y = .epred)\n) +\n  geom_ribbon(\n    data = ersim_sigemax_med_qi |> filter(.width == 0.95),\n    mapping = aes(ymin = .epred.lower, ymax = .epred.upper),\n    fill = \"yellow3\", \n    alpha = 0.5\n  ) +\n  geom_ribbon(\n    data = ersim_sigemax_med_qi |> filter(.width == 0.5),\n    mapping = aes(ymin = .epred.lower, ymax = .epred.upper),\n    fill = \"orange1\"\n  ) +\n  geom_line(\n    data = ersim_sigemax_med_qi |> filter(.width == 0.5), \n    col = \"darkred\"\n  ) +\n  geom_point(\n    data = d_sim_emax, \n    mapping = aes(y = response_1)\n  ) +\n  coord_cartesian(ylim = c(5, 22)) +\n  labs(\n    x = \"Exposure\",\n    y = \"Response\",\n    title = \"Extrapolation (no residual)\",\n    subtitle = \"Represents uncertainty in the model parameters (Credible interval)\",\n    caption = \"95% CI in yellow, 50% CI in orange\"\n  )\n```\n\n::: {.cell-output-display}\n![](simulation_files/figure-html/fig-extrapolation-1-1.png){#fig-extrapolation-1 width=672}\n:::\n:::\n\n\n\n\n\n## with residual error\n\nThis represents uncertainty in the model parameters plus the residual error.\n\n- `p(ynew|xnew, yobs)`\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(\n  data = ersim_sigemax_med_qi, \n  mapping = aes(x = exposure, y = .prediction)\n) +\n  geom_ribbon(\n    data = ersim_sigemax_med_qi |> filter(.width == 0.95),\n    mapping = aes(ymin = .prediction.lower, ymax = .prediction.upper),\n    fill = \"yellow3\", \n    alpha = 0.5\n  ) +\n  geom_ribbon(\n    data = ersim_sigemax_med_qi |> filter(.width == 0.5),\n    mapping = aes(ymin = .prediction.lower, ymax = .prediction.upper),\n    fill = \"orange1\"\n  ) +\n  geom_line(\n    data = ersim_sigemax_med_qi |> filter(.width == 0.5), \n    col = \"darkred\"\n  ) +\n  geom_point(\n    data = d_sim_emax, \n    mapping = aes(y = response_1)\n  ) +\n  coord_cartesian(ylim = c(5, 22)) +\n  labs(\n    x = \"Exposure\",\n    y = \"Response\",\n    title = \"Extrapolation (incl. residual)\",\n    subtitle = \"Represents uncertainty + residual error (Prediction interval)\",\n    caption = \"95% PI in yellow, 50% PI in orange\"\n  )\n```\n\n::: {.cell-output-display}\n![](simulation_files/figure-html/fig-extrapolation-2-1.png){#fig-extrapolation-2 width=672}\n:::\n:::\n\n\n\n\n\n## Overlay Emax and Sigmoidal Emax\n\nNo discernible difference between the two models.\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nersim_emax <-\n  sim_er_new_exp(ermod_emax, new_conc_vec)\n\nersim_emax_med_qi <-\n  ersim_emax |>\n  calc_ersim_med_qi(qi_width = c(0.5, 0.95))\n\nggplot(\n  data = ersim_sigemax_med_qi, \n  mapping = aes(x = exposure, y = .epred)\n) +\n  geom_ribbon(\n    data = ersim_sigemax_med_qi |> filter(.width == 0.95),\n    mapping = aes(ymin = .epred.lower, ymax = .epred.upper),\n    fill = \"orange1\", \n    alpha = 0.5\n  ) +\n  geom_line(\n    data = ersim_sigemax_med_qi |> filter(.width == 0.95), \n    col = \"darkred\"\n  ) +\n  geom_ribbon(\n    data = ersim_emax_med_qi |> filter(.width == 0.95),\n    mapping = aes(ymin = .epred.lower, ymax = .epred.upper),\n    fill = \"turquoise3\", \n    alpha = 0.5\n  ) +\n  geom_line(\n    data = ersim_emax_med_qi |> filter(.width == 0.95), \n    col = \"steelblue3\"\n  ) +\n  geom_point(\n    data = d_sim_emax, \n    mapping = aes(y = response_1)\n  ) +\n  coord_cartesian(ylim = c(5, 22)) +\n  labs(\n    x = \"Exposure\",\n    y = \"Response\",\n    title = \"Extrapolation (no residual)\",\n    subtitle = \"Represents uncertainty in the model parameters (Credible interval)\",\n    caption = \"Sigmoidal Emax: Orange, Emax: Blue, 50% CI\"\n  )\n```\n\n::: {.cell-output-display}\n![](simulation_files/figure-html/fig-emax-sigemax-compare-1.png){#fig-emax-sigemax-compare width=672}\n:::\n:::\n\n\n\n\n\n:::\n\n\n",
    "supporting": [
      "simulation_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}